# =============================================================================
# NitroPack - Automated CFW Bundle Builder
# =============================================================================
# This workflow automatically fetches the latest releases of all CFW components,
# assembles them into an SD-card-ready ZIP, and publishes as a GitHub Release.
#
# Triggers:
#   - Weekly (every Sunday at 00:00 UTC)
#   - Manual dispatch (workflow_dispatch)
#   - Push to main branch (for testing)
#
# DISCLAIMER: This is for educational purposes only. Own your games!
# =============================================================================

name: ğŸš€ Build NitroPack

on:
  # Run weekly on Sunday at midnight UTC
  schedule:
    - cron: '0 0 * * 0'
  
  # Allow manual trigger from GitHub Actions tab
  workflow_dispatch:
    inputs:
      version_override:
        description: 'Override version (leave empty for auto)'
        required: false
        default: ''
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: 'false'
        type: boolean

  # Build on push to main (for testing)
  push:
    branches:
      - main
    paths:
      - 'scripts/**'
      - '.github/workflows/**'
      - 'configs/**'

# Prevent concurrent builds
concurrency:
  group: build-pack
  cancel-in-progress: true

env:
  PACK_NAME: NitroPack
  # Component GitHub repos (owner/repo format)
  ATMOSPHERE_REPO: Atmosphere-NX/Atmosphere
  HEKATE_REPO: CTCaer/hekate
  TESLA_MENU_REPO: WerWolv/Tesla-Menu
  OVLLOADER_REPO: WerWolv/nx-ovlloader
  DBI_REPO: rashevskyv/dbi
  NXTHEMES_REPO: exelix11/SwitchThemeInjector
  GOLDLEAF_REPO: XorTroll/Goldleaf
  JKSV_REPO: J-D-K/JKSV
  NXSHELL_REPO: joel16/NX-Shell

jobs:
  build:
    name: ğŸ”¨ Build Pack
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      atmosphere_version: ${{ steps.fetch_versions.outputs.atmosphere }}
      hekate_version: ${{ steps.fetch_versions.outputs.hekate }}
      
    steps:
      # =========================================================================
      # SETUP
      # =========================================================================
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Environment
        run: |
          # Install required tools
          sudo apt-get update
          sudo apt-get install -y unzip p7zip-full jq curl wget
          
          # Create working directories
          mkdir -p build/{downloads,extracted,output}
          mkdir -p build/output/{atmosphere,bootloader,config,switch}
          
          echo "âœ… Environment ready"

      # =========================================================================
      # FETCH LATEST VERSIONS
      # =========================================================================
      - name: ğŸ“Š Fetch Latest Release Versions
        id: fetch_versions
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ” Fetching latest release information..."
          
          # Function to get latest release tag from GitHub API
          get_latest_release() {
            local repo=$1
            local release_info=$(curl -sL \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${repo}/releases/latest")
            echo "$release_info" | jq -r '.tag_name // empty'
          }
          
          # Fetch all versions
          ATMO_VER=$(get_latest_release "$ATMOSPHERE_REPO")
          HEKATE_VER=$(get_latest_release "$HEKATE_REPO")
          TESLA_VER=$(get_latest_release "$TESLA_MENU_REPO")
          OVLLOADER_VER=$(get_latest_release "$OVLLOADER_REPO")
          DBI_VER=$(get_latest_release "$DBI_REPO")
          NXTHEMES_VER=$(get_latest_release "$NXTHEMES_REPO")
          GOLDLEAF_VER=$(get_latest_release "$GOLDLEAF_REPO")
          JKSV_VER=$(get_latest_release "$JKSV_REPO")
          NXSHELL_VER=$(get_latest_release "$NXSHELL_REPO")
          
          # Output versions
          echo "atmosphere=${ATMO_VER}" >> $GITHUB_OUTPUT
          echo "hekate=${HEKATE_VER}" >> $GITHUB_OUTPUT
          echo "tesla=${TESLA_VER}" >> $GITHUB_OUTPUT
          echo "ovlloader=${OVLLOADER_VER}" >> $GITHUB_OUTPUT
          echo "dbi=${DBI_VER}" >> $GITHUB_OUTPUT
          echo "nxthemes=${NXTHEMES_VER}" >> $GITHUB_OUTPUT
          echo "goldleaf=${GOLDLEAF_VER}" >> $GITHUB_OUTPUT
          echo "jksv=${JKSV_VER}" >> $GITHUB_OUTPUT
          echo "nxshell=${NXSHELL_VER}" >> $GITHUB_OUTPUT
          
          # Print summary
          echo ""
          echo "ğŸ“¦ Component Versions:"
          echo "  Atmosphere:      ${ATMO_VER}"
          echo "  Hekate:          ${HEKATE_VER}"
          echo "  Tesla Menu:      ${TESLA_VER}"
          echo "  nx-ovlloader:    ${OVLLOADER_VER}"
          echo "  DBI:             ${DBI_VER}"
          echo "  NXThemeInstaller:${NXTHEMES_VER}"
          echo "  Goldleaf:        ${GOLDLEAF_VER}"
          echo "  JKSV:            ${JKSV_VER}"
          echo "  NX-Shell:        ${NXSHELL_VER}"

      # =========================================================================
      # DOWNLOAD COMPONENTS
      # =========================================================================
      - name: ğŸ“¥ Download Atmosphere
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“¥ Downloading Atmosphere..."
          cd build/downloads
          
          # Get download URL for atmosphere zip
          RELEASE_INFO=$(curl -sL \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${ATMOSPHERE_REPO}/releases/latest")
          
          # Download atmosphere-*.zip (full package)
          ATMO_URL=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name | test("atmosphere-.*\\.zip$")) | .browser_download_url')
          FUSEE_URL=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name == "fusee.bin") | .browser_download_url')
          
          if [ -n "$ATMO_URL" ]; then
            wget -q --show-progress -O atmosphere.zip "$ATMO_URL"
            echo "âœ… Downloaded Atmosphere package"
          else
            echo "âŒ Failed to find Atmosphere download URL"
            exit 1
          fi
          
          if [ -n "$FUSEE_URL" ]; then
            wget -q --show-progress -O fusee.bin "$FUSEE_URL"
            echo "âœ… Downloaded fusee.bin payload"
          fi

      - name: ğŸ“¥ Download Hekate
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“¥ Downloading Hekate..."
          cd build/downloads
          
          RELEASE_INFO=$(curl -sL \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${HEKATE_REPO}/releases/latest")
          
          # Download hekate_ctcaer_*.zip
          HEKATE_URL=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name | test("hekate_ctcaer.*\\.zip$")) | .browser_download_url')
          
          if [ -n "$HEKATE_URL" ]; then
            wget -q --show-progress -O hekate.zip "$HEKATE_URL"
            echo "âœ… Downloaded Hekate"
          else
            echo "âŒ Failed to find Hekate download URL"
            exit 1
          fi

      - name: ğŸ“¥ Download Tesla Menu
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“¥ Downloading Tesla Menu..."
          cd build/downloads
          
          RELEASE_INFO=$(curl -sL \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${TESLA_MENU_REPO}/releases/latest")
          
          # Download ovlmenu.ovl
          TESLA_URL=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name | test("ovlmenu\\.ovl$")) | .browser_download_url')
          
          if [ -n "$TESLA_URL" ] && [ "$TESLA_URL" != "null" ]; then
            wget -q --show-progress -O ovlmenu.ovl "$TESLA_URL"
            echo "âœ… Downloaded Tesla Menu"
          else
            echo "âš ï¸ Tesla Menu not found, continuing..."
          fi

      - name: ğŸ“¥ Download nx-ovlloader
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“¥ Downloading nx-ovlloader..."
          cd build/downloads
          
          RELEASE_INFO=$(curl -sL \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${OVLLOADER_REPO}/releases/latest")
          
          # Download nx-ovlloader.zip
          OVLLOADER_URL=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name | test("nx-ovlloader\\.zip$")) | .browser_download_url')
          
          if [ -n "$OVLLOADER_URL" ] && [ "$OVLLOADER_URL" != "null" ]; then
            wget -q --show-progress -O nx-ovlloader.zip "$OVLLOADER_URL"
            echo "âœ… Downloaded nx-ovlloader"
          else
            echo "âš ï¸ nx-ovlloader not found, continuing..."
          fi

      - name: ğŸ“¥ Download DBI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“¥ Downloading DBI..."
          cd build/downloads
          
          RELEASE_INFO=$(curl -sL \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${DBI_REPO}/releases/latest")
          
          DBI_URL=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name | test("DBI\\.nro$")) | .browser_download_url')
          
          if [ -n "$DBI_URL" ] && [ "$DBI_URL" != "null" ]; then
            wget -q --show-progress -O DBI.nro "$DBI_URL"
            echo "âœ… Downloaded DBI"
          else
            # Try zip package
            DBI_URL=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name | test("\\.zip$")) | .browser_download_url' | head -1)
            if [ -n "$DBI_URL" ] && [ "$DBI_URL" != "null" ]; then
              wget -q --show-progress -O dbi.zip "$DBI_URL"
              echo "âœ… Downloaded DBI package"
            else
              echo "âš ï¸ DBI not found, continuing..."
            fi
          fi

      - name: ğŸ“¥ Download NXThemeInstaller
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“¥ Downloading NXThemeInstaller..."
          cd build/downloads
          
          RELEASE_INFO=$(curl -sL \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${NXTHEMES_REPO}/releases/latest")
          
          NXTHEMES_URL=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name | test("NXThemesInstaller\\.nro$")) | .browser_download_url')
          
          if [ -n "$NXTHEMES_URL" ] && [ "$NXTHEMES_URL" != "null" ]; then
            wget -q --show-progress -O NXThemesInstaller.nro "$NXTHEMES_URL"
            echo "âœ… Downloaded NXThemeInstaller"
          else
            echo "âš ï¸ NXThemeInstaller not found, continuing..."
          fi

      - name: ğŸ“¥ Download Goldleaf
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“¥ Downloading Goldleaf..."
          cd build/downloads
          
          RELEASE_INFO=$(curl -sL \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${GOLDLEAF_REPO}/releases/latest")
          
          GOLDLEAF_URL=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name | test("Goldleaf\\.nro$")) | .browser_download_url')
          
          if [ -n "$GOLDLEAF_URL" ] && [ "$GOLDLEAF_URL" != "null" ]; then
            wget -q --show-progress -O Goldleaf.nro "$GOLDLEAF_URL"
            echo "âœ… Downloaded Goldleaf"
          else
            echo "âš ï¸ Goldleaf not found, continuing..."
          fi

      - name: ğŸ“¥ Download JKSV
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“¥ Downloading JKSV..."
          cd build/downloads
          
          RELEASE_INFO=$(curl -sL \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${JKSV_REPO}/releases/latest")
          
          JKSV_URL=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name | test("JKSV\\.nro$")) | .browser_download_url')
          
          if [ -n "$JKSV_URL" ] && [ "$JKSV_URL" != "null" ]; then
            wget -q --show-progress -O JKSV.nro "$JKSV_URL"
            echo "âœ… Downloaded JKSV"
          else
            echo "âš ï¸ JKSV not found, continuing..."
          fi

      - name: ğŸ“¥ Download NX-Shell
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“¥ Downloading NX-Shell..."
          cd build/downloads
          
          RELEASE_INFO=$(curl -sL \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${NXSHELL_REPO}/releases/latest")
          
          NXSHELL_URL=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name | test("NX-Shell\\.nro$")) | .browser_download_url')
          
          if [ -n "$NXSHELL_URL" ] && [ "$NXSHELL_URL" != "null" ]; then
            wget -q --show-progress -O NX-Shell.nro "$NXSHELL_URL"
            echo "âœ… Downloaded NX-Shell"
          else
            echo "âš ï¸ NX-Shell not found, continuing..."
          fi

      # =========================================================================
      # EXTRACT & ASSEMBLE
      # =========================================================================
      - name: ğŸ“¦ Extract & Assemble Pack
        run: |
          echo "ğŸ“¦ Assembling NitroPack..."
          cd build
          
          # Extract Atmosphere (provides base structure)
          echo "  â†’ Extracting Atmosphere..."
          unzip -q -o downloads/atmosphere.zip -d output/
          
          # Extract Hekate
          echo "  â†’ Extracting Hekate..."
          unzip -q -o downloads/hekate.zip -d output/
          
          # Extract nx-ovlloader (Tesla sysmodule)
          if [ -f downloads/nx-ovlloader.zip ]; then
            echo "  â†’ Extracting nx-ovlloader..."
            unzip -q -o downloads/nx-ovlloader.zip -d output/
          fi
          
          # Extract DBI if zip exists
          if [ -f downloads/dbi.zip ]; then
            echo "  â†’ Extracting DBI..."
            unzip -q -o downloads/dbi.zip -d extracted/dbi/
            mkdir -p output/switch/DBI
            find extracted/dbi -name "*.nro" -exec cp {} output/switch/DBI/ \;
            find extracted/dbi -name "*.ini" -exec cp {} output/switch/DBI/ \; 2>/dev/null || true
          elif [ -f downloads/DBI.nro ]; then
            mkdir -p output/switch/DBI
            cp downloads/DBI.nro output/switch/DBI/
          fi
          
          # Copy standalone NRO files
          echo "  â†’ Organizing homebrew apps..."
          
          # Setup Tesla Menu overlay
          if [ -f downloads/ovlmenu.ovl ]; then
            mkdir -p output/switch/.overlays
            cp downloads/ovlmenu.ovl output/switch/.overlays/
          fi
          
          if [ -f downloads/NXThemesInstaller.nro ]; then
            mkdir -p output/switch/NXThemesInstaller
            cp downloads/NXThemesInstaller.nro output/switch/NXThemesInstaller/
          fi
          
          if [ -f downloads/Goldleaf.nro ]; then
            mkdir -p output/switch/Goldleaf
            cp downloads/Goldleaf.nro output/switch/Goldleaf/
          fi
          
          if [ -f downloads/JKSV.nro ]; then
            mkdir -p output/switch/JKSV
            cp downloads/JKSV.nro output/switch/JKSV/
          fi
          
          if [ -f downloads/NX-Shell.nro ]; then
            mkdir -p output/switch/NX-Shell
            cp downloads/NX-Shell.nro output/switch/NX-Shell/
          fi
          
          # Copy fusee.bin to payloads
          if [ -f downloads/fusee.bin ]; then
            mkdir -p output/bootloader/payloads
            cp downloads/fusee.bin output/bootloader/payloads/
          fi
          
          echo "âœ… Base assembly complete"

      - name: ğŸ“ Apply Custom Configs
        run: |
          echo "ğŸ“ Applying NitroPack configurations..."
          cd build/output
          
          # Create hekate_ipl.ini with NitroPack branding
          cat > bootloader/hekate_ipl.ini << 'EOF'
          # NitroPack - Hekate Configuration
          # https://github.com/Zephyron-Dev/NitroPack
          
          [config]
          autoboot=0
          autoboot_list=0
          bootwait=3
          backlight=100
          autohosoff=0
          autonogc=1
          updater2p=1
          bootprotect=0
          
          [Atmosphere (CFW)]
          payload=bootloader/payloads/fusee.bin
          icon=bootloader/res/icon_payload.bmp
          
          [Stock (OFW)]
          fss0=atmosphere/package3
          stock=1
          emummc_force_disable=1
          icon=bootloader/res/icon_switch.bmp
          EOF
          
          # Create exosphere.ini for blanked prodinfo
          cat > exosphere.ini << 'EOF'
          # NitroPack - Exosphere Configuration
          # Blanks serial number for additional ban protection
          # NOTE: This is NOT a guarantee against bans!
          
          [exosphere]
          debugmode=1
          debugmode_user=0
          disable_user_exception_handlers=0
          enable_user_pmu_access=0
          blank_prodinfo_sysmmc=0
          blank_prodinfo_emummc=1
          allow_writing_to_cal_sysmmc=0
          log_port=0
          log_baud_rate=115200
          log_inverted=0
          EOF
          
          # Create atmosphere config directory and files
          mkdir -p atmosphere/config
          
          # System settings
          cat > atmosphere/config/system_settings.ini << 'EOF'
          # NitroPack - Atmosphere System Settings
          
          [atmosphere]
          ; Power menu reboot options
          power_menu_reboot_function = payload
          
          [eupld]
          ; Disable error uploads to Nintendo
          upload_enabled = u8!0x0
          
          [ro]
          ; Enable easier homebrewing
          ease_nro_restriction = u8!0x1
          EOF
          
          # Override config for homebrew menu
          cat > atmosphere/config/override_config.ini << 'EOF'
          # NitroPack - Override Configuration
          
          [hbl_config]
          ; Open homebrew menu by holding R and launching Album
          program_id=010000000000100D
          override_any_app=true
          override_any_app_key=R
          override_any_app_address_space=39_bit
          EOF
          
          # Create Tesla config directory
          mkdir -p config/tesla
          cat > config/tesla/config.ini << 'EOF'
          [tesla]
          ; Key combo: L + Down + R3 (click right stick)
          key_combo=L+DDOWN+RSTICK
          EOF
          
          # Create hosts directory for DNS blocking (empty by default)
          mkdir -p atmosphere/hosts
          cat > atmosphere/hosts/emummc.txt << 'EOF'
          # NitroPack - DNS Blocking (emuMMC)
          # Uncomment lines below to block Nintendo servers
          # This adds another layer of ban protection
          
          # Nintendo servers (uncomment to block)
          #127.0.0.1 *nintendo.*
          #127.0.0.1 *nintendo-europe.com
          #127.0.0.1 *nintendoswitch.*
          #127.0.0.1 95.216.149.205
          #127.0.0.1 *conntest.nintendowifi.net
          #127.0.0.1 *ctest.cdn.nintendo.net
          EOF
          
          echo "âœ… Configurations applied"

      - name: ğŸ“‹ Create Version Info
        id: version
        run: |
          echo "ğŸ“‹ Creating version information..."
          cd build/output
          
          # Get current date for version
          BUILD_DATE=$(date +%Y%m%d)
          
          # Use override version if provided, otherwise auto-generate
          if [ -n "${{ github.event.inputs.version_override }}" ]; then
            VERSION="${{ github.event.inputs.version_override }}"
          else
            # Version format: vYYYY.MM.DD
            VERSION="v$(date +%Y.%m.%d)"
          fi
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          
          # Create version file
          cat > NitroPack_Version.txt << EOF
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘                         N I T R O P A C K                        â•‘
          â•‘               Ultimate Nintendo Switch CFW Bundle                â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘  Version:     ${VERSION}
          â•‘  Build Date:  $(date +"%Y-%m-%d %H:%M:%S UTC")
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘  COMPONENT VERSIONS                                              â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘  Atmosphere:        ${{ steps.fetch_versions.outputs.atmosphere }}
          â•‘  Hekate:            ${{ steps.fetch_versions.outputs.hekate }}
          â•‘  Tesla Menu:        ${{ steps.fetch_versions.outputs.tesla }}
          â•‘  nx-ovlloader:      ${{ steps.fetch_versions.outputs.ovlloader }}
          â•‘  DBI:               ${{ steps.fetch_versions.outputs.dbi }}
          â•‘  NXThemeInstaller:  ${{ steps.fetch_versions.outputs.nxthemes }}
          â•‘  Goldleaf:          ${{ steps.fetch_versions.outputs.goldleaf }}
          â•‘  JKSV:              ${{ steps.fetch_versions.outputs.jksv }}
          â•‘  NX-Shell:          ${{ steps.fetch_versions.outputs.nxshell }}
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘  DISCLAIMER: For educational purposes only. Own your games!      â•‘
          â•‘  https://github.com/Zephyron-Dev/NitroPack                      â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          EOF
          
          echo "âœ… Version: ${VERSION}"

      # =========================================================================
      # PACKAGE & RELEASE
      # =========================================================================
      - name: ğŸ“¦ Create ZIP Package
        run: |
          echo "ğŸ“¦ Creating final ZIP package..."
          cd build/output
          
          VERSION="${{ steps.version.outputs.version }}"
          ZIP_NAME="${PACK_NAME}-${VERSION}.zip"
          
          # Create ZIP with maximum compression
          zip -r -9 "../../${ZIP_NAME}" .
          
          # Calculate checksums
          cd ../..
          sha256sum "${ZIP_NAME}" > "${ZIP_NAME}.sha256"
          md5sum "${ZIP_NAME}" > "${ZIP_NAME}.md5"
          
          echo "âœ… Package created: ${ZIP_NAME}"
          echo "   Size: $(du -h ${ZIP_NAME} | cut -f1)"
          
          # List contents summary
          echo ""
          echo "ğŸ“ Package contents:"
          unzip -l "${ZIP_NAME}" | tail -1

      - name: ğŸ“¤ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: NitroPack-${{ steps.version.outputs.version }}
          path: |
            NitroPack-*.zip
            NitroPack-*.sha256
            NitroPack-*.md5
          retention-days: 30

      - name: ğŸ·ï¸ Create Release
        if: github.event_name != 'push'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: "ğŸ® NitroPack ${{ steps.version.outputs.version }}"
          draft: false
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
          generate_release_notes: false
          body: |
            # ğŸ® NitroPack ${{ steps.version.outputs.version }}
            
            **The goated all-in-one CFW bundle for Nintendo Switch**
            
            ---
            
            ## ğŸ“¦ Component Versions
            
            | Component | Version |
            |-----------|---------|
            | Atmosphere | `${{ steps.fetch_versions.outputs.atmosphere }}` |
            | Hekate | `${{ steps.fetch_versions.outputs.hekate }}` |
            | Tesla Menu | `${{ steps.fetch_versions.outputs.tesla }}` |
            | nx-ovlloader | `${{ steps.fetch_versions.outputs.ovlloader }}` |
            | DBI | `${{ steps.fetch_versions.outputs.dbi }}` |
            | NXThemeInstaller | `${{ steps.fetch_versions.outputs.nxthemes }}` |
            | Goldleaf | `${{ steps.fetch_versions.outputs.goldleaf }}` |
            | JKSV | `${{ steps.fetch_versions.outputs.jksv }}` |
            | NX-Shell | `${{ steps.fetch_versions.outputs.nxshell }}` |
            
            ---
            
            ## ğŸ“¥ Installation
            
            1. Download `NitroPack-${{ steps.version.outputs.version }}.zip` below
            2. Extract to the **root** of your SD card
            3. Inject `hekate_ctcaer_*.bin` payload via RCM
            4. Boot into Atmosphere CFW
            
            **Tesla Menu:** Press `L + Down + R3` in-game to open overlay menu.
            
            See [README](https://github.com/${{ github.repository }}#-installation) for detailed instructions.
            
            ---
            
            ## âš ï¸ Disclaimer
            
            This software is provided for **educational purposes only**. 
            - You MUST own legitimate copies of any games you play
            - Using CFW carries risk of console ban
            - The maintainers are NOT responsible for any damage or legal issues
            
            **Always back up your NAND before installing CFW!**
            
            ---
            
            ## ğŸ” Checksums
            
            Verify your download integrity using the `.sha256` or `.md5` files.
            
            ```
            sha256sum -c NitroPack-${{ steps.version.outputs.version }}.zip.sha256
            ```
          files: |
            NitroPack-*.zip
            NitroPack-*.sha256
            NitroPack-*.md5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # =========================================================================
      # CLEANUP & SUMMARY
      # =========================================================================
      - name: ğŸ“Š Build Summary
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                    BUILD COMPLETE âœ…                             â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  Version:     ${{ steps.version.outputs.version }}"
          echo "â•‘  Atmosphere:  ${{ steps.fetch_versions.outputs.atmosphere }}"
          echo "â•‘  Hekate:      ${{ steps.fetch_versions.outputs.hekate }}"
          echo "â•‘  Tesla:       ${{ steps.fetch_versions.outputs.tesla }}"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  Package Size: $(du -h NitroPack-*.zip | cut -f1)"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
